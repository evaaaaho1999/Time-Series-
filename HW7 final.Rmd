---
title: "Time Series HW7"
author: '106070020'
date: "2021年6月13日"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Library
```{r message=F, warning=F}
library(aTSA)
library(vars)
library(forecast)
library(tseries)
```

## Data cleaning
```{r message=F, warning=F}
econ<-read.csv("C:/Users/eva/Desktop/作業 上課資料(清大)/大四下/時序/hw7/econ_data.csv", header = T)
dim(econ)
head(econ)
econ[is.na(econ)] #no NAs
econ$DATE<-as.Date(econ$DATE, format =  "%Y/%m/%d" )
summary(econ)
str(econ)
```

***
>確保資料型態以及缺失值等等。

## EDA
```{r message=F, warning=F}
par(mfrow=c(1,1))
series_name = colnames(econ)
for (i in 1:7){
  y = econ[,1+(i-1)*3+(1:3)]
  ts.plot(y, col=1:3) 
  legend("topleft", legend=series_name[1+(i-1)*3+(1:3)], col=1:3, lty=1, lwd=2, bty="n")
}
```


## Data Preprocessing
### box-cox
```{r message=F, warning=F}
# box-cox
par(mfrow=c(1,1))
lambda <- BoxCox.lambda(econ$United.Kingdom_CPI)
print(lambda)
plot.ts(BoxCox(econ$United.Kingdom_CPI, lambda = lambda), main='Box-Cox transformation')
kc1<-BoxCox(econ$United.Kingdom_CPI, lambda = lambda)

par(mfrow=c(1,1))
lambda <- BoxCox.lambda(econ$United.Kingdom_gdp)
print(lambda)
plot.ts(BoxCox(econ$United.Kingdom_gdp, lambda = lambda), main='Box-Cox transformation')
kg1<-BoxCox(econ$United.Kingdom_gdp, lambda = lambda)

par(mfrow=c(1,1))
lambda <- BoxCox.lambda(econ$United.Kingdom_unem)
print(lambda)
plot.ts(BoxCox(econ$United.Kingdom_unem, lambda = lambda), main='Box-Cox transformation')
ku1<-BoxCox(econ$United.Kingdom_unem, lambda = lambda)
```

***
> 利用Box-Cox transformation，使轉換後的資料變異數齊一，更似常態分佈。 其中，計算出的lambda值分別為-0.5051194，0.6011321，0.1844793，並將轉換後的資料繪製成圖，並存為新的變數。

### Differencing
```{r message=F, warning=F}
dkc<-diff(kc1)
{par(mfrow=c(3,1))
  {ts.plot(dkc)
    abline(h=mean(dkc))
}
  acf(dkc)
  pacf(dkc)}

dkg<-diff(kg1)
{par(mfrow=c(3,1))
  {ts.plot(dkg)
    abline(h=mean(dkg))
}
  acf(dkg)
  pacf(dkg)}

dku<-diff(ku1)
{par(mfrow=c(3,1))
  {ts.plot(dku)
    abline(h=mean(dku))
}
  acf(dku)
  pacf(dku)}
```

### ADF Test
```{r message=F}
adf.test(dkc)
adf.test(dkg)
adf.test(dku)
```

***
> 經由一次差分消除local trend，並利用ADF Test測試stationality. ADF Test的p-value為0.01，0.01，0.015，說明這三個序列皆為stationary.


### Plots
```{r message=F, warning=F}
uk=cbind(dkc,dkg,dku)
colnames(uk)=c('United.Kingdom_CPI','United.Kingdom_gdp','United.Kingdom_unem')
ts.plot(uk, col=1:3) 
legend("bottomright", legend=colnames(uk), col=1:3, lty=1, lwd=2, bty="n")
```

***
> 此圖為經過差分的序列圖。

### ACF plots
```{r message=F, warning=F}
pairs(uk, col=4, pch=16)
par(mfrow=c(1,1))
acf(uk) #sample ccf
pacf(uk) 
```

***
>繪製出這三筆data的scatter plot 和 ccf。

## Model fitting
### order selection
```{r message=F, warning=F}
fit = VARselect(uk, lag.max=10, type="both")
fit
names(fit)
par(mfcol=c(1,1))
ts.plot(t(fit$crit[1:3,]), col=1:3, lwd=2, xlab="AR Order")
abline(v=fit$sel[1:3],lty=2,col=1:3,lwd=2)
legend("topleft",legend=rownames(fit$crit[1:3,]),col=1:3,lty=1, bty="n")
title("Information Criteria")
```

***
> 利用VARselect選擇出最適合的order。根據BIC，應該選擇order=1，根據AIC、FPC、HQ，應選擇order=4。因此以下為兩個模型的fitting。

## Order=1
```{r message=F, warning=F}
fit1 = VAR(uk, p=1, type="both",season=4)
summary(fit1)
```

### Serial Test
```{r}
serial.test(fit1, lags.pt = 8, type = "PT.asymptotic")
```

***
>由於serial test的結果不顯著，可知無法拒絕服從white noise process的假設。


### Coefficients
```{r message=F, warning=F}
Acoef(fit1)  #estimated AR coeff matrix
round(Bcoef(fit1),5)  #all estimated coeff
```

***
>上述結果即為參數估計的結果。


### Residuals
```{r message=F, warning=F}
fit1$resid = resid(fit1)
acf(fit1$resid,52)
```

***
> 由上圖可知，residuals 是 white noise process. 

### Model plots
```{r message=F, warning=F}
plot(fit1) #plot fitted values and residuals w/ ACF and PACF
```

***
>結果為正相關。

### Causality
```{r message=F, warning=F}
causality(fit1, cause= "United.Kingdom_CPI")
causality(fit1, cause= "United.Kingdom_gdp")
causality(fit1, cause= "United.Kingdom_unem")
```

***
>
檢查序列間是否存在granger causality 和 instantaneous causality。舉例而言，觀察United.Kingdom_CPI、United.Kingdom_gdp、United.Kingdom_unem分別對其他兩者的因果關係。

+ 由第一個causality的結果可知不能拒絕H0，United.Kingdom_CPI 對於United.Kingdom_gdp和United.Kingdom_unem無顯著相關性，然而他們有當期的相關性。
+ 由第二個causality的結果可知可以拒絕H0，United.Kingdom_gdp 對於United.Kingdom_CPI和United.Kingdom_unem有相關性，並且同時有當期的相關性。
+ 由第一個causality的結果可知不能拒絕H0，United.Kingdom_unem 對於United.Kingdom_gdp和United.Kingdom_CPI無顯著相關性，然而他們有當期的相關性。

>就結果可知，United.Kingdom_CPI及United.Kingdom_unem對其餘時間序列均無granger causality，顯示兩序列的過去值對其餘序列無顯著解釋能力。然而，United.Kingdom_gdp則對其餘序列有顯著解釋能力，即United.Kingdom_gdp這筆序列對其餘序列具有預測能力。

### Prediction
```{r message=F, warning=F}
fit1$pred = predict(fit1, n.ahead = 24, ci = 0.95)
plot(fit1$pred, lwd=2) 
fanchart(fit1$pred) 
```


## Order=4
```{r message=F, warning=F}
fit4 = VAR(uk, p=4, type="both",season=4)
summary(fit4)
```

### Serial Test
```{r}
serial.test(fit4, lags.pt = 8, type = "PT.asymptotic")
```

***
>由於serial test的結果不顯著，可知無法拒絕服從white noise process的假設。

### Coefficients
```{r message=F, warning=F}
Acoef(fit4)  #estimated AR coeff matrix
round(Bcoef(fit4),5)  #all estimated coeff
```

***
>上述結果即為參數估計的結果。

### Residuals
```{r message=F, warning=F}
fit4$resid = resid(fit4)
acf(fit4$resid,52)
```

***
> 由上圖可知，residuals 是 white noise process. 

### Model plots
```{r message=F, warning=F}
plot(fit4) #plot fitted values and residuals w/ ACF and PACF
```

***
>結果為正相關。

### Causality
```{r message=F, warning=F}
causality(fit4, cause= "United.Kingdom_CPI")
causality(fit4, cause= "United.Kingdom_gdp")
causality(fit4, cause= "United.Kingdom_unem")
```

***
>
檢查序列間是否存在granger causality 和 instantaneous causality並觀察United.Kingdom_CPI、United.Kingdom_gdp、United.Kingdom_unem分別對其他兩者的因果關係。

+ 由第一個causality的結果可知可以拒絕H0，United.Kingdom_CPI 對於United.Kingdom_gdp和United.Kingdom_unem有相關性，並且也有當期的相關性。
+ 由第二個causality的結果可知不能拒絕H0，United.Kingdom_gdp 對於United.Kingdom_CPI和United.Kingdom_unem無顯著相關性，然而他們有當期的相關性。
+ 由第一個causality的結果可知不能拒絕H0，United.Kingdom_unem 對於United.Kingdom_gdp和United.Kingdom_CPI無顯著相關性，然而他們有當期的相關性。

>就結果可知，United.Kingdom_gdp及United.Kingdom_unem對其餘時間序列均無granger causality，顯示兩序列的過去值對其餘序列無顯著解釋能力。然而，United.Kingdom_CPI則對其餘序列有顯著解釋能力，即United.Kingdom_gdp這筆序列對其餘序列具有預測能力。

### Prediction
```{r message=F, warning=F}
fit4$pred = predict(fit4, n.ahead = 24, ci = 0.95)
plot(fit4$pred, lwd=2) 
fanchart(fit4$pred) 
```


### AIC
```{r}
AIC1<-2*9-2*638.761
AIC1
AIC4<-2*17-2*642.203
AIC4
```

***
> 由於AIC1(-1259.522) < AIC4(-1250.406)，可得知fit1模型的預測能力較好。


